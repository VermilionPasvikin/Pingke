# 评课系统部署与维护指南

## 目录

1. [项目简介](#项目简介)
2. [环境准备](#环境准备)
3. [依赖安装](#依赖安装)
4. [后端服务部署](#后端服务部署)
   - [开发环境配置](#开发环境配置)
   - [生产环境配置](#生产环境配置)
   - [Docker部署](#docker部署)
5. [前端小程序部署](#前端小程序部署)
   - [开发环境设置](#开发环境设置)
   - [API接口配置](#api接口配置)
   - [前端API调用说明](#前端api调用说明)
   - [本地开发与调试](#本地开发与调试)
   - [小程序发布流程](#小程序发布流程)
6. [系统维护](#系统维护)
   - [数据库备份](#数据库备份)
   - [日志管理](#日志管理)
   - [性能监控](#性能监控)
7. [常见问题排查](#常见问题排查)
   - [后端服务问题](#后端服务问题)
   - [前端小程序问题](#前端小程序问题)
8. [附录](#附录)
   - [数据模型](#数据模型)
   - [项目结构](#项目结构)
   - [常用命令](#常用命令)

## 项目简介

评课系统是一个前后端分离的微信小程序应用，用于学生评价课程和教师，提供讨论区和排行榜功能。

- 后端：基于Flask的RESTful API服务
- 前端：微信小程序
- 数据库：SQLAlchemy ORM支持多种数据库

## 环境准备

### 后端环境要求

- Python 3.7+ 
- pip 20.0+ 
- 可选：虚拟环境工具（如venv、virtualenv）
- 数据库：SQLite（默认，开发环境）或 MySQL 5.7+（推荐，生产环境）
- 依赖包：Flask 2.0.1, Werkzeug 2.0.1, Flask-SQLAlchemy 2.5.1, SQLAlchemy 1.4.46, Flask-RESTful 0.3.9, Flask-CORS 3.0.10, marshmallow 3.14.1, python-dotenv 0.19.0, sympy 1.13.1, pymysql 1.0.2, cryptography 36.0.2

### 前端环境要求

- 微信开发者工具最新版
- 微信小程序账号
- 稳定的网络环境

## 依赖安装

### 后端依赖安装

1. 克隆项目代码到本地：
   ```bash
   git clone <项目仓库地址>
   cd pingke/backend
   ```

2. 创建并激活虚拟环境（推荐）：
   ```bash
   # Windows
   python -m venv venv
   venv\Scripts\activate
   
   # macOS/Linux
   python3 -m venv venv
   source venv/bin/activate
   ```

3. 安装依赖包：
   ```bash
   pip install -r requirements.txt
   ```

### 前端依赖说明

前端使用微信小程序原生开发，无需额外的包管理工具。在微信开发者工具中打开项目即可自动加载所需资源。

## 后端服务部署

### 配置文件设置

1. 在`backend`目录下创建`.env`文件（如果不存在）：
   ```bash
   cd backend
   copy .env.example .env  # Windows
   # 或
   cp .env.example .env  # macOS/Linux
   ```

2. 编辑`.env`文件，设置相关配置：
   ```env
   FLASK_APP=run.py
   FLASK_ENV=development
   
   # 数据库连接信息（SQLite默认配置）
   DATABASE_URL="sqlite:///app.db"
   
   # MySQL配置示例（可选）
   # DATABASE_URL="mysql+pymysql://admin:password@localhost:3306/pingke"
   
   SECRET_KEY="your-secret-key"
   
   # 微信小程序配置（用于认证）
   WECHAT_APPID="your-wechat-appid"
   WECHAT_SECRET="your-wechat-secret"
   ```
   
   > **注意**：实际部署时请使用强密码，并确保数据库用户权限配置正确。

### 数据库初始化

#### MySQL数据库准备（生产环境）

1. 登录MySQL服务器：
   ```bash
   mysql -u root -p
   ```

2. 创建数据库和配置：
   ```sql
   CREATE DATABASE pingke CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   -- 可以使用root用户或创建专用用户
   -- 如果使用专用用户，请取消下面的注释并执行
   -- CREATE USER 'pingke_user'@'localhost' IDENTIFIED BY 'your_secure_password';
   -- GRANT ALL PRIVILEGES ON pingke.* TO 'pingke_user'@'localhost';
   FLUSH PRIVILEGES;
   EXIT;
   ```

3. 更新`.env`文件中的数据库连接信息（根据实际使用的用户）：
   ```env
   DATABASE_URL="mysql+pymysql://root:your_password_here@localhost:3306/pingke"
   -- 或使用专用用户
   -- DATABASE_URL="mysql+pymysql://pingke_user:your_secure_password@localhost:3306/pingke"
   ```

#### SQLite数据库准备（开发环境）

1. SQLite数据库会在应用首次启动时自动创建，无需额外配置

#### 数据表初始化

1. 确保虚拟环境已激活，运行以下命令启动应用初始化数据库：
   ```bash
   python run.py
   ```
   数据库表会在应用启动时自动创建

### 测试数据导入（可选）

为了方便开发和测试，可以导入示例数据。按照以下步骤操作：

#### 1. 准备测试数据文件

在`backend`目录下创建`data`文件夹，并创建测试数据文件：

```python
# backend/data/test_data.py
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.models import db, Teacher, Course, Evaluation, Comment
from app import create_app

# 创建应用实例
app = create_app()

# 在应用上下文中导入数据
with app.app_context():
    # 创建教师数据
    teachers = [
        Teacher(name='张三', department='计算机与人工智能学院', title='教授'),
        Teacher(name='李四', department='计算机与人工智能学院', title='副教授'),
        Teacher(name='王五', department='数学与统计学院', title='讲师'),
        Teacher(name='赵六', department='物理与电子工程学院', title='教授')
    ]
    
    # 批量添加并提交教师数据
    db.session.add_all(teachers)
    db.session.commit()
    
    # 创建课程数据
    courses = [
        Course(course_code='CS101', name='数据结构', description='介绍数据结构基本概念和算法', 
               credit=3, semester='2024春', teacher_id=1),
        Course(course_code='CS202', name='操作系统', description='学习操作系统原理和实现', 
               credit=4, semester='2024春', teacher_id=1),
        Course(course_code='EE303', name='数字电路', description='数字电路设计与应用', 
               credit=3, semester='2024春', teacher_id=2),
        Course(course_code='MTH404', name='高等数学', description='高等数学基础', 
               credit=5, semester='2024春', teacher_id=3),
        Course(course_code='PHY505', name='量子力学', description='量子力学入门', 
               credit=4, semester='2024春', teacher_id=4)
    ]
    
    # 批量添加并提交课程数据
    db.session.add_all(courses)
    db.session.commit()
    
    # 创建评价数据
    evaluations = [
        Evaluation(course_id=1, user_id='user1', score=5, workload_score=4, 
                  content_score=5, teaching_score=5, tags='干货,易懂', 
                  comment='老师讲得非常好，内容充实，容易理解'),
        Evaluation(course_id=1, user_id='user2', score=4, workload_score=5, 
                  content_score=4, teaching_score=4, tags='作业多,实用', 
                  comment='课程内容实用，但作业较多'),
        Evaluation(course_id=2, user_id='user3', score=4, workload_score=3, 
                  content_score=4, teaching_score=5, tags='深入,清晰', 
                  comment='讲解深入，思路清晰'),
        Evaluation(course_id=3, user_id='user4', score=5, workload_score=4, 
                  content_score=5, teaching_score=5, tags='有趣,易上手', 
                  comment='非常有趣的课程，老师讲解生动'),
        Evaluation(course_id=4, user_id='user5', score=3, workload_score=5, 
                  content_score=3, teaching_score=4, tags='抽象,难', 
                  comment='内容较抽象，需要花时间理解')
    ]
    
    # 批量添加并提交评价数据
    db.session.add_all(evaluations)
    db.session.commit()
    
    # 创建评论数据
    comments = [
        Comment(course_id=1, user_id='user10', user_name='小明', 
               content='请问这门课期末考试难吗？'),
        Comment(course_id=1, user_id='user11', user_name='小红', 
               content='不难，只要平时认真听课就能过', parent_id=1),
        Comment(course_id=2, user_id='user12', user_name='小李', 
               content='这门课有实验吗？'),
        Comment(course_id=3, user_id='user13', user_name='小王', 
               content='老师推荐的教材很好用'),
        Comment(course_id=4, user_id='user14', user_name='小张', 
               content='求课程笔记分享')
    ]
    
    # 批量添加并提交评论数据
    db.session.add_all(comments)
    db.session.commit()
    
    print("测试数据导入成功！")
    print(f"导入教师数量: {len(teachers)}")
    print(f"导入课程数量: {len(courses)}")
    print(f"导入评价数量: {len(evaluations)}")
    print(f"导入评论数量: {len(comments)}")
```

#### 2. 运行测试数据导入脚本

```bash
# 在backend目录下运行
python data/test_data.py
```

#### 3. 验证数据导入

启动应用后，可以通过API接口或数据库查询验证数据是否成功导入：

```bash
# MySQL命令行验证示例
mysql -u pingke_user -p pingke

# 查询教师表
SELECT * FROM teachers;

# 查询课程表
SELECT * FROM courses;

# 查询评价表
SELECT * FROM evaluations;

# 查询评论表
SELECT * FROM comments;
```

#### 注意事项

1. 测试数据仅用于开发和测试环境，生产环境请使用真实数据
2. 导入数据前确保数据库已初始化
3. 如需修改测试数据，请直接编辑`test_data.py`文件中的内容

### 开发环境运行

1. 在`backend`目录下，执行以下命令启动开发服务器：
   ```bash
   # 创建虚拟环境（推荐）
   python -m venv venv

   # 激活虚拟环境
   # Windows
   venv\Scripts\activate
   # macOS/Linux
   source venv/bin/activate

   # 安装依赖
   pip install -r requirements.txt

   # 初始化数据库（首次运行）
   python -c "from app import create_app, db; app = create_app(); with app.app_context(): db.create_all()"

   # 启动应用
   python run.py
   ```

2. 服务默认运行在`http://0.0.0.0:5001`，API接口地址为`http://localhost:5001/api`

3. 开发模式下，代码修改会自动重新加载

### 生产环境部署

#### 选项1：使用Gunicorn（推荐）

1. 安装Gunicorn和其他生产环境依赖：
   ```bash
   pip install gunicorn pymysql cryptography
   ```

2. 设置环境变量：
   ```bash
   export FLASK_ENV=production
   export DATABASE_URL="mysql+pymysql://admin:password@localhost:3306/pingke"
   export SECRET_KEY="your-production-secret-key"
   ```

3. 使用Gunicorn启动应用：
   ```bash
   cd backend
   gunicorn -w 4 -b 0.0.0.0:5001 "app:create_app()"
   ```
   - `-w 4`：启动4个工作进程
   - `-b 0.0.0.0:5001`：绑定地址和端口

4. 使用supervisor进行进程管理（推荐）：
   ```bash
   # 安装supervisor
   sudo pip install supervisor

   # 生成配置文件
   echo_supervisord_conf > supervisord.conf

   # 编辑配置文件，添加以下内容
   # [program:pingke]
   # command=/path/to/venv/bin/gunicorn -w 4 -b 0.0.0.0:5001 "app:create_app()"
   # directory=/path/to/pingke/backend
   # autostart=true
   # autorestart=true
   # stderr_logfile=/var/log/pingke.err.log
   # stdout_logfile=/var/log/pingke.out.log
   ```

#### 选项2：使用Docker（容器化部署）

1. 创建`Dockerfile`：
   ```dockerfile
   FROM python:3.9-slim
   
   WORKDIR /app
   
   COPY requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   
   COPY . .
   
   ENV FLASK_APP=run.py
   ENV FLASK_ENV=production
   
   EXPOSE 5001
   
   CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5001", "app:create_app()"]
   ```

2. 构建Docker镜像：
   ```bash
   docker build -t pingke-backend .
   ```

3. 运行Docker容器：
   ```bash
   docker run -d -p 5001:5001 --name pingke-backend pingke-backend
   ```

### 服务验证

1. 服务启动后，可通过以下方式验证API是否正常工作：
   ```bash
   curl http://localhost:5001/api/courses
   ```
   如果返回课程列表的JSON数据，则说明服务运行正常。

## 前端小程序部署

### 开发环境设置

1. 安装微信开发者工具：
   - 访问[微信开发者工具官方下载页面](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
   - 下载并安装适合您操作系统的最新版本

2. 登录微信开发者工具：
   - 打开微信开发者工具
   - 使用微信扫码登录

3. 导入小程序项目：
   - 点击"导入项目"按钮
   - 选择项目根目录下的`frontend`文件夹
   - 填写小程序AppID（如果没有，可选择"测试号"）
   - 项目名称填写"评课系统"
   - 点击"导入"按钮

### API接口配置

1. 打开`frontend/app.js`文件，修改API基础URL配置：
   ```javascript
   globalData: {
     userInfo: null,
     apiBaseUrl: 'http://localhost:5001/api',  // 开发环境API地址（实际使用的地址）
     token: ''
     // 生产环境应改为：'https://your-domain.com/api'
   },
   onLaunch() {
     // 从本地存储获取token
     const token = wx.getStorageSync('token');
     if (token) {
       this.globalData.token = token;
     }
   }
   ```

2. 在`utils/request.js`中添加JWT认证：
   ```javascript
   const request = (url, options = {}) => {
     const app = getApp();
     
     // 添加请求头，包含JWT token
     options.header = {
       ...options.header,
       'Content-Type': 'application/json',
       'Authorization': `Bearer ${app.globalData.token}`
     };
     
     return new Promise((resolve, reject) => {
       wx.request({
         url: app.globalData.apiBaseUrl + url,
         ...options,
         success(res) {
           resolve(res);
         },
         fail(err) {
           reject(err);
         }
       });
     });
   };
   ```

2. 确保后端服务已启动，API地址与前端配置一致

### 前端API调用说明

#### API请求工具

前端使用`utils/request.js`封装了所有与后端的API交互，支持Promise化的请求方式，并包含完整的错误处理和加载提示功能。

```javascript
// 导入请求工具
const { request, get, post, put, del } = require('../../utils/request.js');

// 使用方法示例
// GET请求 (支持分页)
await get('/courses', { page: 1, limit: 10 }, true); // 第三个参数控制是否显示加载提示

// POST请求 (提交评价)
await post('/evaluations', {
  course_id: 1,
  score: 5,
  comment: '课程非常好！',
  tags: '干货,有趣',
  workload_score: 4,
  content_score: 5,
  teaching_score: 5
});

// 带认证的请求
// token会自动从本地存储中获取并添加到请求头
await get('/courses/1/evaluations');
```

#### 主要API接口

根据项目结构，系统支持以下主要API接口：

| API路径 | 方法 | 功能描述 | 请求参数 | 成功响应 |
|---------|------|----------|----------|----------|
| `/api/courses` | GET | 获取课程列表 | page, limit | `{ courses: [], total: 100 }` |
| `/api/courses/:id` | GET | 获取课程详情 | - | `{ id, name, course_code, ... }` |
| `/api/courses/:id/evaluations` | GET | 获取课程评价 | page, limit | `{ evaluations: [], total: 50 }` |
| `/api/evaluations` | POST | 提交课程评价 | course_id, score, comment, tags, workload_score, content_score, teaching_score | `{ id, score, comment, ... }` |
| `/api/evaluations/:id/like` | POST | 点赞评价 | - | `{ success: true, likes: 10 }` |
| `/api/courses/:id/comments` | GET | 获取课程评论 | page, limit | `{ comments: [], total: 30 }` |
| `/api/comments` | POST | 发表评论 | course_id, content, user_name, parent_id | `{ id, content, user_name, ... }` |
| `/api/comments/:id/like` | POST | 点赞评论 | - | `{ success: true, likes: 15 }` |
| `/api/courses/search` | GET | 搜索课程 | keyword | `{ courses: [] }` |
| `/api/rankings` | GET | 获取排行榜数据 | type | `{ courses: [] }` |
| `/api/teachers/:id` | GET | 获取教师详情 | - | `{ id, name, department, ... }` |
| `/api/discussions` | GET | 获取讨论区内容 | page, limit | `{ discussions: [] }` |

### 本地开发与调试

1. 在微信开发者工具中，点击"编译"按钮启动项目
2. 使用模拟器或真机调试查看效果
3. 利用开发者工具提供的调试功能检查API请求和响应

### 小程序发布流程

#### 1. 代码审核前准备

1. 更新生产环境API地址：
   - 修改`frontend/app.js`中的`apiBaseUrl`为生产环境地址
   
2. 完善小程序信息：
   - 登录[微信公众平台](https://mp.weixin.qq.com/)
   - 进入"设置" -> "基本设置"，完善小程序名称、头像、介绍等信息

#### 2. 提交审核

1. 在微信开发者工具中：
   - 点击"上传"按钮
   - 填写版本号（如1.0.0）和项目备注
   - 点击"上传"按钮

2. 在微信公众平台：
   - 进入"开发管理" -> "版本管理"
   - 找到刚刚上传的版本，点击"提交审核"
   - 填写审核信息，包括功能介绍、测试账号等
   - 点击"提交审核"

#### 3. 发布上线

1. 审核通过后，在微信公众平台：
   - 进入"开发管理" -> "版本管理"
   - 找到审核通过的版本
   - 点击"发布"按钮
   - 确认发布

### 小程序更新机制

小程序支持自动更新和手动更新两种方式：

1. 自动更新（推荐）：在`app.js`中添加以下代码，实现小程序启动时自动检查更新
   ```javascript
   onLaunch: function() {
     // 检查更新
     if (wx.canIUse('getUpdateManager')) {
       const updateManager = wx.getUpdateManager()
       updateManager.onCheckForUpdate(function(res) {
         if (res.hasUpdate) {
           updateManager.onUpdateReady(function() {
             wx.showModal({
               title: '更新提示',
               content: '新版本已经准备好，是否重启应用？',
               success(res) {
                 if (res.confirm) {
                   updateManager.applyUpdate()
                 }
               }
             })
           })
         }
       })
     }
   }
   ```

2. 手动更新：用户可在小程序内通过下拉刷新等方式触发更新

## 系统维护

### 数据库维护

#### 数据备份

1. SQLite数据库备份：
   ```bash
   # Windows
   copy app.db app.db.backup
   
   # macOS/Linux
   cp app.db app.db.backup
   ```

2. MySQL数据库备份：
   ```bash
   mysqldump -u username -p pingke > pingke_backup.sql
   ```

3. 定期备份建议：设置定时任务，每周或每天自动备份数据库

#### 数据恢复

1. SQLite数据库恢复：
   ```bash
   # Windows
   copy app.db.backup app.db
   
   # macOS/Linux
   cp app.db.backup app.db
   ```

2. MySQL数据库恢复：
   ```bash
   mysql -u username -p pingke < pingke_backup.sql
   ```

### 日志管理

#### 后端日志

1. Flask应用日志默认输出到控制台，可通过以下方式配置日志文件：
   ```python
   # 在app/__init__.py中添加
   import logging
   from logging.handlers import RotatingFileHandler
   
   # 配置日志
   if not app.debug:
       file_handler = RotatingFileHandler('app.log', maxBytes=10240, backupCount=10)
       file_handler.setFormatter(logging.Formatter(
           '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
       ))
       file_handler.setLevel(logging.INFO)
       app.logger.addHandler(file_handler)
       app.logger.setLevel(logging.INFO)
   ```

2. 日志分析工具：可使用ELK Stack（Elasticsearch, Logstash, Kibana）进行日志收集和分析

### 性能监控

1. 使用Flask-MonitoringDashboard进行API性能监控：
   ```bash
   pip install flask_monitoringdashboard
   ```

2. 在`app/__init__.py`中添加：
   ```python
   from flask_monitoringdashboard import Dashboard
   Dashboard(app)
   ```

3. 访问`http://localhost:5001/dashboard`查看性能监控数据

### 安全管理

1. 定期更新依赖包：
   ```bash
   pip list --outdated
   pip install --upgrade package-name
   ```

2. 设置强密码和定期更换密码
3. 使用HTTPS协议加密传输
4. 限制API访问频率，防止恶意请求
5. 定期检查服务器安全漏洞

### 定期维护任务

1. 每周：
   - 备份数据库
   - 检查日志文件，清理旧日志
   - 更新依赖包

2. 每月：
   - 全面系统检查
   - 性能优化
   - 安全审计

## 常见问题排查

### 后端服务问题

#### 问题1：服务无法启动

**可能原因**：
- 端口被占用
- 依赖包缺失
- 配置文件错误
- 数据库连接失败

**解决方案**：
```bash
# 检查端口占用情况
# Windows
netstat -ano | findstr :5001

# macOS/Linux
lsof -i :5001

# 停止占用端口的进程或修改服务端口

# 检查依赖安装
pip install -r requirements.txt

# 检查环境配置文件
cat .env
```

#### 问题2：API返回500错误

**可能原因**：
- 数据库连接失败
- 代码逻辑错误
- 资源不足

**解决方案**：
- 检查数据库服务是否正常运行
- 查看应用日志获取详细错误信息
- 检查数据库连接配置是否正确
- 检查Flask日志：
  ```bash
  # 在backend目录下运行以查看详细错误
  python run.py
  # 或查看gunicorn日志（生产环境）
  ```

#### 问题3：数据库连接失败

**可能原因**：
- 数据库服务未启动
- 连接配置错误
- 数据库权限问题
- MySQL驱动问题

**解决方案**：
- 确认数据库服务状态：
  ```bash
  # MySQL服务状态检查
  # Windows
  services.msc (找到MySQL服务查看状态)
  # macOS/Linux
  systemctl status mysql
  ```
- 检查`.env`文件中的数据库连接配置：
  ```env
  DATABASE_URL="mysql+pymysql://username:password@localhost:3306/pingke"
  ```
- 验证数据库用户权限
- 确保已安装MySQL驱动：
  ```bash
  pip install pymysql
  ```

#### 问题4：课程学院信息显示为"-"而非实际学院名称

**可能原因**：
- CourseSchema未包含department字段
- 前端未正确处理department数据

**解决方案**：
- 确保`backend/app/schemas/__init__.py`中CourseSchema的teacher嵌套字段包含department：
  ```python
  teacher = fields.Nested(TeacherSchema(only=('id', 'name', 'title', 'department')))
  ```
- 确保前端`course_detail.js`中正确处理部门信息：
  ```javascript
  // 在success回调中处理数据
  const courseData = res.data;
  // 从teacher.department提取学院信息
  if (courseData.teacher && courseData.teacher.department) {
    courseData.department = courseData.teacher.department;
  }
  ```

### 前端小程序问题

#### 问题1：API请求失败

**可能原因**：
- API基础URL配置错误
- 网络连接问题
- 跨域访问限制

**解决方案**：
- 检查`app.js`中的`apiBaseUrl`配置是否正确
- 确保后端服务正在运行
- 开发环境中可在微信开发者工具中开启"不校验合法域名"

#### 问题2：课程详情页学院信息显示不正确

**可能原因**：
- 前端未正确处理教师信息中的学院字段
- 后端未返回完整的教师信息

**解决方案**：
- 检查`course_detail.js`中的数据处理逻辑
- 确保后端API返回的课程数据包含完整的teacher信息

#### 问题3：小程序上传审核失败

**可能原因**：
- 使用了测试环境API地址
- 小程序内容不符合审核规范
- 缺少必要的权限声明

**解决方案**：
- 将`app.js`中的`apiBaseUrl`修改为生产环境地址
- 确保小程序内容合规
- 在`app.json`中添加必要的权限声明



#### 问题2：页面白屏或显示异常

**可能原因**：
- JavaScript错误
- 数据格式不正确
- 页面路径配置错误

**解决方案**：
- 查看微信开发者工具的控制台错误信息
- 检查API返回的数据格式
- 确认`app.json`中的页面路径配置正确

#### 问题3：小程序无法登录

**可能原因**：
- 用户未授权
- 登录接口错误
- Session过期

**解决方案**：
- 检查用户授权设置
- 验证登录API是否正常工作
- 确认Session管理逻辑正确

### 网络问题

#### 问题1：前后端通信延迟高

**可能原因**：
- 服务器负载过高
- 网络带宽不足
- 数据传输量过大

**解决方案**：
- 优化服务器配置，增加资源
- 考虑使用CDN加速
- 优化数据传输，实现数据压缩

#### 问题2：跨域访问被拒绝

**解决方案**：
- 确认后端已正确配置CORS
- 检查请求头设置
- 对于生产环境，考虑将前后端部署在同一域名下

## 附录

### 数据模型

#### 用户表 (users)
- **id**: 用户ID (主键，INTEGER)
- **openid**: 微信OpenID (唯一标识)
- **nickname**: 用户昵称
- **avatar_url**: 头像URL
- **gender**: 性别
- **created_at**: 创建时间 (TIMESTAMP)
- **updated_at**: 更新时间 (TIMESTAMP)

#### 教师表 (teachers)
- **id**: 教师ID (主键，INTEGER)
- **name**: 教师姓名 (必填)
- **department**: 所属学院
- **title**: 职称
- **introduction**: 教师简介
- **created_at**: 创建时间 (TIMESTAMP)
- **updated_at**: 更新时间 (TIMESTAMP)

#### 课程表 (courses)
- **id**: 课程ID (主键，INTEGER)
- **course_code**: 课程代码 (唯一，必填)
- **name**: 课程名称 (必填)
- **description**: 课程描述
- **credit**: 学分
- **semester**: 学期
- **teacher_id**: 授课教师ID (外键关联teachers表)
- **created_at**: 创建时间 (TIMESTAMP)
- **updated_at**: 更新时间 (TIMESTAMP)

#### 标签表 (tags)
- **id**: 标签ID (主键，INTEGER)
- **name**: 标签名称 (唯一，必填)
- **created_at**: 创建时间 (TIMESTAMP)

#### 课程标签关联表 (course_tags)
- **course_id**: 课程ID (外键关联courses表)
- **tag_id**: 标签ID (外键关联tags表)
- (course_id, tag_id) 联合唯一约束

#### 评价表 (evaluations)
- **id**: 评价ID (主键，INTEGER)
- **course_id**: 课程ID (外键关联courses表，必填)
- **user_id**: 用户ID (外键关联users表，必填)
- **score**: 总评分 (1-5分，必填)
- **workload_score**: 工作量评分
- **content_score**: 内容评分
- **teaching_score**: 教学评分
- **comment**: 评价内容
- **created_at**: 创建时间 (TIMESTAMP)
- **updated_at**: 更新时间 (TIMESTAMP)

#### 评价点赞表 (evaluation_likes)
- **id**: 点赞ID (主键，INTEGER)
- **evaluation_id**: 评价ID (外键关联evaluations表)
- **user_id**: 用户ID (外键关联users表)
- **created_at**: 创建时间 (TIMESTAMP)
- (evaluation_id, user_id) 联合唯一约束

#### 评论表 (comments)
- **id**: 评论ID (主键，INTEGER)
- **course_id**: 课程ID (外键关联courses表)
- **user_id**: 用户ID (外键关联users表，必填)
- **content**: 评论内容 (必填)
- **parent_id**: 父评论ID (自引用，用于回复功能)
- **created_at**: 创建时间 (TIMESTAMP)
- **updated_at**: 更新时间 (TIMESTAMP)

#### 评论点赞表 (comment_likes)
- **id**: 点赞ID (主键，INTEGER)
- **comment_id**: 评论ID (外键关联comments表)
- **user_id**: 用户ID (外键关联users表)
- **created_at**: 创建时间 (TIMESTAMP)
- (comment_id, user_id) 联合唯一约束

### 项目结构

```
pingke/
├── backend/                  # 后端Flask应用
│   ├── app/                  # 应用主目录
│   │   ├── __init__.py       # 应用初始化
│   │   ├── api/              # API路由模块
│   │   │   ├── __init__.py   # API初始化（路由在各模块文件末尾单独注册）
│   │   │   ├── auth.py       # 认证相关API（微信登录等）
│   │   │   ├── courses.py    # 课程相关API
│   │   │   ├── teachers.py   # 教师相关API
│   │   │   ├── evaluations.py # 评价相关API
│   │   │   ├── comments.py   # 评论相关API
│   │   │   ├── rankings.py   # 排行榜相关API
│   │   │   └── users.py      # 用户相关API
│   │   ├── models/           # 数据模型
│   │   │   └── __init__.py   # 所有模型定义在此文件中
│   │   ├── schemas/          # 数据校验模式
│   │   │   └── __init__.py   # 所有Schema定义在此文件中
│   │   ├── utils/            # 工具函数
│   │   │   └── __init__.py   # 工具导入
│   ├── .env                  # 环境变量配置
│   ├── requirements.txt      # 依赖列表
│   ├── run.py                # 应用入口
│   └── venv/                 # 虚拟环境（可选）
├── frontend/                 # 前端微信小程序
│   ├── app.js                # 小程序入口
│   ├── app.json              # 全局配置
│   ├── app.wxss              # 全局样式
│   ├── assets/               # 资源文件（图标等）
│   ├── components/           # 自定义组件
│   ├── pages/                # 页面文件
│   │   ├── index/            # 首页（课程列表）
│   │   ├── course_detail/    # 课程详情
│   │   ├── evaluation_list/  # 评价列表
│   │   ├── write_evaluation/ # 写评价
│   │   ├── rankings/         # 排行榜
│   │   ├── comment/          # 评论详情
│   │   └── user/             # 用户相关页面
│   ├── project.config.json   # 项目配置文件
│   ├── project.private.config.json # 私有配置
│   └── utils/                # 工具函数
│       └── request.js        # 网络请求封装
├── API文档.md               # API接口文档
├── 系统设计文档.md          # 系统设计文档
└── 部署与维护指南.md        # 部署和维护文档
```

### 常用命令

#### 后端命令

```bash
# 启动开发服务器
python run.py

# 使用Gunicorn启动生产服务器
gunicorn -w 4 -b 0.0.0.0:5001 "app:create_app()"

# 安装依赖
pip install -r requirements.txt

# 导出依赖列表
pip freeze > requirements.txt

# 检查依赖更新
pip list --outdated

# 更新依赖
pip install --upgrade package-name
```

#### 数据库命令

```bash
# SQLite数据库备份
cp app.db app.db.backup

# SQLite数据库恢复
cp app.db.backup app.db

# MySQL数据库备份
mysqldump -u username -p pingke > pingke_backup.sql

# MySQL数据库恢复
mysql -u username -p pingke < pingke_backup.sql
```

#### Docker相关命令

```bash
# 构建Docker镜像
docker build -t pingke-backend .

# 运行Docker容器
docker run -d -p 5001:5001 --name pingke-backend pingke-backend

# 查看容器状态
docker ps

# 查看容器日志
docker logs pingke-backend

# 停止容器
docker stop pingke-backend

# 重启容器
docker restart pingke-backend
```



### 联系信息

如有问题或建议，请联系项目维护团队。

### 许可证

本项目遵循[MIT许可证](https://opensource.org/licenses/MIT)。